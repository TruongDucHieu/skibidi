<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý Y tế AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            /* Lược bỏ background-image cũ để thay bằng hiệu ứng động */
        }
        
        /* [NEW] Hiệu ứng nền động */
        #background-animations {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-image: radial-gradient(#dbeafe 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .floating-icon {
            position: absolute;
            bottom: -100px;
            font-size: 2rem;
            color: rgba(59, 130, 246, 0.2);
            animation: floatUp linear infinite;
            user-select: none;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            10%, 90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh);
                opacity: 0;
            }
        }
        /* Kết thúc hiệu ứng nền */

        .view {
            display: none;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 1.5rem;
        }
        .main-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .gradient-border {
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px; 
            border-radius: inherit;
            background: linear-gradient(145deg, #3b82f6, #10b981, #8b5cf6);
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(10px);
            animation: bubble-in 0.5s forwards;
        }
        @keyframes bubble-in {
            to { opacity: 1; transform: translateY(0); }
        }

        .user-bubble {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .ai-bubble {
            background-color: #ffffff;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-bubble.typing {
            font-style: italic;
            color: #6b7280;
        }

        .lookup-result-content h1 { font-size: 1.8rem; font-weight: 800; color: #1e3a8a; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .lookup-result-content h2 { font-size: 1.3rem; font-weight: 700; color: #1d4ed8; margin-top: 2rem; margin-bottom: 0.75rem; }
        .lookup-result-content ul { list-style-type: none; padding-left: 0; }
        .lookup-result-content li { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2310b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>') no-repeat left center; padding-left: 28px; margin-bottom: 0.75rem; line-height: 1.6; }
        .lookup-result-content strong { color: #1f2937; font-weight: 600; }
        .lookup-result-content p { margin-bottom: 0.5rem; line-height: 1.6; }
        .lookup-result-content code { background-color: #eef2ff; color: #4338ca; padding: 2px 6px; border-radius: 6px; font-family: monospace; }
        
        #image-preview-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        #image-preview-container .img-wrapper { position: relative; }
        #image-preview-container img { height: 10rem; width: 10rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); object-fit: cover; border: 2px solid transparent; transition: all 0.2s ease; }
        #image-preview-container img:hover { transform: scale(1.05); border-color: #6366f1; }
        
        .animate-modal-scale-in {
            animation: modal-scale-in 0.5s cubic-bezier(0.165, 0.840, 0.440, 1.000) both;
        }
        @keyframes modal-scale-in {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        .pro-input {
            border: 1px solid #d1d5db;
            transition: all 0.3s;
        }
        .pro-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .pro-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .pro-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1);
        }
        .pro-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="background-animations"></div>

    <div id="welcome-modal" class="fixed top-0 left-0 right-0 bottom-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center animate-modal-scale-in">
            <lottie-player src="https://lottie.host/0c973623-a523-45aa-9782-d6b33b7aaa4e/7RZ7RZ57x7.json" background="transparent" speed="1" style="width: 150px; height: 150px; margin: 0 auto;" loop autoplay></lottie-player>
            <h2 class="text-3xl font-bold text-blue-700 mb-3">Lưu ý Quan Trọng</h2>
            <p class="text-gray-600 mb-6">
                Thông tin từ "Trợ lý Y tế AI" chỉ mang tính chất tham khảo, <strong>không thay thế</strong> cho chẩn đoán và chỉ định của bác sĩ.
                <br><br>
                Vui lòng đến cơ sở y tế để nhận tư vấn chính xác nhất.
            </p>
            <button onclick="acceptDisclaimer()" class="pro-btn bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 w-full md:w-auto">
                Tôi đã hiểu và đồng ý
            </button>
        </div>
    </div>
    
    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6 flex flex-col flex-grow w-full">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-green-500 py-2">
                Trợ lý Y tế AI
            </h1>
            <p class="text-gray-500 mt-2 text-lg">Nền tảng tra cứu thuốc và tư vấn sức khỏe thông minh</p>
        </header>

        <div id="main-menu" class="view">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <button onclick="showView('text-lookup-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://lottie.host/38382a88-3596-49f4-9878-e1b1149a8395/129xXoMyvW.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-blue-700">Tra cứu thông tin thuốc</h2>
                    <p class="text-gray-600 mt-2">Nhập tên thuốc để xem chi tiết công dụng, liều dùng và lưu ý.</p>
                </button>
                
                <button onclick="showView('ai-chat-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://assets9.lottiefiles.com/packages/lf20_vPnn3K.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-green-700">Trò chuyện với Bác sĩ AI</h2>
                    <p class="text-gray-600 mt-2">Hỏi đáp về triệu chứng và nhận lời khuyên sức khỏe ban đầu.</p>
                </button>

                <button onclick="showView('image-lookup-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://lottie.host/f61f9fda-34c3-4200-a031-03cbe68011cd/e8DTjYj8hL.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-indigo-700">Tra cứu bằng hình ảnh</h2>
                    <p class="text-gray-600 mt-2">Chụp ảnh hộp thuốc để AI nhận diện và cung cấp thông tin.</p>
                </button>

                <button onclick="showView('copyright-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://lottie.host/93c183f4-f0ad-4331-b02b-7c52b1d47263/mQsl6EePvt.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-gray-700">Thông tin & Bản quyền</h2>
                    <p class="text-gray-600 mt-2">Chi tiết về đơn vị phát triển ứng dụng.</p>
                </button>
            </div>
        </div>
        
        <div class="view-container bg-white/80 backdrop-blur-lg rounded-2xl shadow-lg p-6 md:p-8 border border-gray-200/50" style="display: none;">
            </div>

        <template id="text-lookup-view-template">
            <button onclick="showView('main-menu')" class="mb-6 text-blue-600 hover:underline font-semibold">&larr; Quay lại trang chủ</button>
            <h2 class="text-3xl font-bold mb-6 text-blue-800">💊 Tra cứu thông tin thuốc</h2>
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <input id="drug-name-input" type="text" placeholder="Nhập tên thuốc, ví dụ: Paracetamol, thuốc ho,..." class="flex-grow p-3 border rounded-lg pro-input">
                <button id="lookup-drug-btn" onclick="lookupDrug()" class="pro-btn bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">
                    Tra cứu
                </button>
            </div>
            <div id="text-lookup-result" class="bg-gray-50 p-6 rounded-lg shadow-inner flex-grow overflow-y-auto break-words lookup-result-content min-h-[300px]">
                <p class="text-gray-500">Kết quả tra cứu sẽ hiển thị ở đây...</p>
            </div>
        </template>
        
        <template id="ai-chat-view-template">
             <button onclick="showView('main-menu')" class="mb-6 text-green-600 hover:underline font-semibold">&larr; Quay lại trang chủ</button>
            <h2 class="text-3xl font-bold mb-4 text-green-800">👨‍⚕️ Trò chuyện với Bác sĩ AI</h2>
            <div id="chat-window" class="flex-grow bg-gray-50 p-4 rounded-lg shadow-inner overflow-y-auto h-96 flex flex-col space-y-4 mb-4">
                </div>
            <div class="flex gap-4">
                <input id="chat-input" type="text" placeholder="Nhập câu hỏi của bạn..." class="flex-grow p-3 border rounded-lg pro-input focus:ring-green-500 focus:border-green-500">
                <button id="send-chat-btn" onclick="sendChatMessage()" class="pro-btn bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700">
                    Gửi
                </button>
            </div>
        </template>
        
        <template id="image-lookup-view-template">
            <button onclick="showView('main-menu')" class="mb-6 text-indigo-600 hover:underline font-semibold">&larr; Quay lại trang chủ</button>
            <h2 class="text-3xl font-bold mb-4 text-indigo-800">📸 Tra cứu thuốc bằng hình ảnh</h2>
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-4 text-center">
                 <input type="file" id="image-upload-input" class="hidden" accept="image/*" onchange="previewImage(event)" multiple>
                 <label for="image-upload-input" class="cursor-pointer bg-indigo-100 text-indigo-700 font-semibold py-3 px-5 rounded-lg border-2 border-dashed border-indigo-300 hover:bg-indigo-200 transition-colors duration-300">
                     Chọn một hoặc nhiều ảnh
                 </label>
                 <div id="image-preview-container"></div>
            </div>
            <button id="lookup-image-btn" onclick="lookupByImage()" class="w-full pro-btn bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none" disabled>
                Phân tích ảnh
            </button>
            <div id="image-lookup-result" class="bg-gray-50 p-6 rounded-lg shadow-inner mt-4 flex-grow overflow-y-auto break-words lookup-result-content min-h-[300px]">
                 <p class="text-gray-500">Kết quả phân tích hình ảnh sẽ hiển thị ở đây...</p>
            </div>
        </template>

        <template id="copyright-view-template">
             <button onclick="showView('main-menu')" class="mb-6 text-gray-600 hover:underline font-semibold">&larr; Quay lại trang chủ</button>
            <div class="text-center">
                <lottie-player src="https://lottie.host/93c183f4-f0ad-4331-b02b-7c52b1d47263/mQsl6EePvt.json" background="transparent" speed="1" style="width: 150px; height: 150px; margin: 0 auto 1rem;" loop autoplay></lottie-player>
                <h2 class="text-3xl font-bold mb-2">Thông tin Bản quyền</h2>
                <p class="text-gray-700 text-lg">Ứng dụng này được phát triển và giữ bản quyền bởi:</p>
                <p class="font-bold text-2xl mt-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">Trương Đức Hiếu & Nguyễn Duy Hưng</p>
            </div>
        </template>
    </div>

    <footer class="text-center p-4 mt-auto">
        <p class="text-gray-500">&copy; 2025 Trợ lý Y tế AI. Phát triển bởi Trương Đức Hiếu & Nguyễn Duy Hưng.</p>
    </footer>

    <script>
        // --- Configuration ---
        const API_KEY = "AIzaSyCUaOs_IbaBu7t1PRL-IyOVCN6v2VWI5MM"; // !!! QUAN TRỌNG: Thay thế bằng API Key của bạn
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        
        // --- State Management ---
        let chatHistory = [];
        let base64Images = [];

        // --- PROMPT ENGINEERING: Upgraded Prompts ---

        const CHAT_SYSTEM_INSTRUCTION = {
            parts: [{ text: `Bạn là một "Bác sĩ AI" - một trợ lý y tế ảo. Hãy tuân thủ nghiêm ngặt các quy tắc sau trong mọi tương tác:
1.  **Persona (Vai trò):** Luôn duy trì giọng văn tận tâm, thấu hiểu, thân thiện và chuyên nghiệp. Sử dụng ngôn ngữ dễ hiểu, tránh biệt ngữ y khoa phức tạp. Bắt đầu cuộc trò chuyện bằng lời chào ấm áp.
2.  **Disclaimer (Tuyên bố miễn trừ trách nhiệm):** Trong câu trả lời ĐẦU TIÊN và lặp lại khi cần thiết (ví dụ: khi người dùng hỏi về chẩn đoán hoặc đơn thuốc), hãy nhấn mạnh rằng bạn chỉ cung cấp thông tin tham khảo và không thể thay thế cho việc chẩn đoán trực tiếp từ bác sĩ chuyên khoa. Khuyến khích người dùng đến gặp bác sĩ.
3.  **Năng lực:**
    * **Tư vấn triệu chứng:** Phân tích các triệu chứng người dùng cung cấp, đưa ra các khả năng có thể xảy ra (không khẳng định chẩn đoán) và khuyên nên đi khám chuyên khoa nào.
    * **Thông tin thuốc:** Cung cấp thông tin chi tiết về thuốc.
    * **Lời khuyên sức khỏe:** Đưa ra lời khuyên về lối sống, dinh dưỡng, phòng bệnh.
4.  **Giới hạn:** Tuyệt đối KHÔNG đưa ra chẩn đoán y khoa cuối cùng. KHÔNG kê đơn thuốc. KHÔNG thay thế bác sĩ. Nếu được yêu cầu làm những việc này, hãy từ chối một cách lịch sự và giải thích lý do.
5.  **Định dạng:** Sử dụng Markdown (in đậm, gạch đầu dòng) để trình bày thông tin một cách rõ ràng, dễ đọc.`}]
        };

        const initialAiMessage = {
            role: "model",
            parts: [{ text: "Chào bạn! Tôi là bác sĩ AI, rất vui được trò chuyện và lắng nghe bạn. Bạn đang có băn khoăn hay vấn đề sức khỏe nào cần tôi tư vấn không? Hãy cứ thoải mái chia sẻ nhé! Tôi sẽ cố gắng hết sức để đưa ra những lời khuyên hữu ích và dễ hiểu nhất cho bạn. \n\n**Lưu ý quan trọng:** Những thông tin tôi chia sẻ chỉ mang tính tham khảo thôi. Để có chẩn đoán chính xác và điều trị chuyên sâu, bạn hãy tìm gặp bác sĩ chuyên khoa để được thăm khám trực tiếp nhé!" }]
        };

        // [UPDATED] Prompt tra cứu thuốc linh hoạt hơn
        function getTextLookupPrompt(drugName) {
            return `Bạn là một trợ lý dược phẩm AI thân thiện. Người dùng muốn tìm hiểu về "${drugName}".
Nhiệm vụ của bạn là:
1.  **Ưu tiên nhận dạng:** Cố gắng hết sức để xác định xem "${drugName}" có phải là một loại thuốc cụ thể (Tây y, Đông y, thuốc nam,...) không.
2.  **Nếu nhận dạng được:**
    * Cung cấp thông tin quan trọng nhất một cách rõ ràng: **Công dụng chính, Cách dùng tham khảo, và Tác dụng phụ cần lưu ý.**
    * Trình bày dưới dạng Markdown dễ đọc, không cần theo một khuôn mẫu quá cứng nhắc.
3.  **Nếu KHÔNG nhận dạng được hoặc thông tin quá chung chung (ví dụ: "thuốc ho", "thuốc nam", "thuốc bổ"):**
    * **Đừng báo lỗi.** Thay vào đó, hãy cung cấp thông tin tổng quan, hữu ích liên quan đến chủ đề đó.
    * Ví dụ với "thuốc ho": Hãy giải thích về các loại thuốc ho khác nhau (long đờm, giảm ho khan), chúng hoạt động như thế nào, và khi nào nên sử dụng loại nào.
    * Ví dụ với "thuốc nam": Hãy giới thiệu sơ lược về y học cổ truyền Việt Nam, nêu một vài vị thuốc nam phổ biến cho các bệnh thông thường (như trị cảm, ho) và nhấn mạnh tầm quan trọng của việc tham khảo ý kiến thầy thuốc y học cổ truyền.
4.  **Luôn kết thúc bằng lời khuyên:** Nhắc nhở người dùng rằng thông tin này chỉ để tham khảo và họ **luôn phải tuân theo chỉ định của bác sĩ hoặc dược sĩ** trước khi sử dụng bất kỳ loại thuốc nào.

Hãy bắt đầu phân tích và trả lời một cách hữu ích nhất.`;
        }

        // [UPDATED] Prompt tra cứu ảnh linh hoạt hơn
        function getImageLookupPrompt() {
            return `Bạn là một chuyên gia dược phẩm AI. Phân tích các hình ảnh được cung cấp.
1.  **Cố gắng nhận dạng:** Xác định tên thuốc, hoạt chất, và các thông tin quan trọng khác từ ảnh.
2.  **Nếu nhận dạng thành công:** Cung cấp thông tin chi tiết về thuốc đó (công dụng, liều dùng, tác dụng phụ).
3.  **Nếu ảnh mờ hoặc không thể nhận dạng rõ:**
    * **Đừng chỉ báo lỗi.** Hãy thử mô tả những gì bạn thấy và đưa ra phỏng đoán nếu có thể. Ví dụ: "Hình ảnh hơi mờ, nhưng dường như đây là một vỉ thuốc kháng sinh. Bạn có thể đọc được chữ nào trên vỉ thuốc không?"
    * Gợi ý người dùng chụp lại ảnh rõ nét hơn hoặc cung cấp thêm thông tin.
4.  **Nếu không có thuốc nào trong ảnh:** Nhận xét một cách lịch sự về nội dung của ảnh.
5.  **Luôn bao gồm disclaimer:** Nhắc nhở người dùng thông tin chỉ mang tính tham khảo và cần hỏi ý kiến chuyên gia y tế.`;
        }
        
        // --- UI Control ---
        function acceptDisclaimer() {
            const modal = document.getElementById('welcome-modal');
            const app = document.getElementById('app');
            modal.classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => {
                modal.style.display = 'none';
                app.style.display = 'flex';
                showView('main-menu');
            }, 500);
        }

        function showView(viewId) {
            const mainMenu = document.getElementById('main-menu');
            const viewContainer = document.querySelector('.view-container');
            
            mainMenu.style.display = 'none';
            viewContainer.style.display = 'none';

            const currentlyVisible = document.querySelector('.view.active');
            if (currentlyVisible) {
                currentlyVisible.classList.remove('active', 'animate__animated', 'animate__fadeIn');
            }

            if (viewId === 'main-menu') {
                mainMenu.style.display = 'block';
                mainMenu.classList.add('view', 'active', 'animate__animated', 'animate__fadeIn');
            } else {
                const template = document.getElementById(`${viewId}-template`);
                if (template) {
                    viewContainer.innerHTML = template.innerHTML;
                    viewContainer.style.display = 'block';
                    viewContainer.classList.add('view', 'active', 'animate__animated', 'animate__fadeIn');
                    addEventListenersForView(viewId);

                    if (viewId === 'ai-chat-view') {
                        initializeChat();
                    }
                }
            }
        }
        
        function addEventListenersForView(viewId) {
            if (viewId === 'text-lookup-view') {
                 document.getElementById('drug-name-input').addEventListener('keypress', e => e.key === 'Enter' && lookupDrug());
            } else if (viewId === 'ai-chat-view') {
                 document.getElementById('chat-input').addEventListener('keypress', e => e.key === 'Enter' && sendChatMessage());
            }
        }
        
        function showLoader(resultElementId) {
            const resultDiv = document.getElementById(resultElementId);
            resultDiv.innerHTML = `<div class="flex flex-col items-center justify-center p-8">
                <lottie-player src="https://assets3.lottiefiles.com/packages/lf20_hymw0cm6.json" background="transparent" speed="1" style="width: 150px; height: 150px;" loop autoplay></lottie-player>
                <p class="text-center text-gray-500 mt-4">AI đang phân tích, vui lòng chờ trong giây lát...</p>
            </div>`;
        }

        function renderMarkdown(elementId, text) {
            const element = document.getElementById(elementId);
            element.innerHTML = marked.parse(text);
        }

        // --- API Call Logic ---
        async function callGemini(payload) {
             if (!API_KEY || API_KEY === "") {
                 return "Lỗi: Vui lòng thay thế **API Key mẫu** trong file mã nguồn bằng **API Key của chính bạn** để sử dụng chức năng này. Bạn có thể lấy API Key từ Google AI Studio.";
             }
             try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    throw new Error(errorData.error.message);
                }
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                     return result.candidates[0].content.parts[0].text;
                } else {
                     console.error("Invalid API Response:", result);
                     let finishReason = result.candidates?.[0]?.finishReason;
                     if (finishReason === 'SAFETY') {
                         return "Phản hồi từ AI đã bị chặn vì lý do an toàn. Vui lòng điều chỉnh câu hỏi của bạn.";
                     }
                     return "Lỗi: Phản hồi từ AI không hợp lệ hoặc rỗng. Vui lòng thử lại.";
                }
             } catch(error) {
                console.error("Fetch Error:", error);
                return `Đã xảy ra lỗi kết nối đến AI: ${error.message}. Vui lòng kiểm tra lại API Key và kết nối mạng.`;
             }
        }
        
        // --- Feature 1: Text Lookup ---
        async function lookupDrug() {
            const drugName = document.getElementById('drug-name-input').value.trim();
            if (!drugName) {
                alert("Vui lòng nhập tên thuốc.");
                return;
            }
            showLoader('text-lookup-result');
            const prompt = getTextLookupPrompt(drugName);
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.4 } }; // Tăng nhẹ temp để linh hoạt hơn
            const resultText = await callGemini(payload);
            renderMarkdown('text-lookup-result', resultText);
        }

        // --- Feature 2: AI Chat ---
        function initializeChat() {
            chatHistory = [initialAiMessage];
            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = ''; 
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';
            aiBubble.innerHTML = marked.parse(initialAiMessage.parts[0].text);
            chatWindow.appendChild(aiBubble);
        }

        async function sendChatMessage() {
            const userInput = document.getElementById('chat-input').value.trim();
            if (!userInput) return;
            
            const chatWindow = document.getElementById('chat-window');
            
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-bubble';
            userBubble.textContent = userInput;
            chatWindow.appendChild(userBubble);
            chatHistory.push({ role: "user", parts: [{ text: userInput }] });
            document.getElementById('chat-input').value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble ai-bubble typing';
            typingIndicator.innerHTML = 'Bác sĩ AI đang soạn tin...';
            chatWindow.appendChild(typingIndicator);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const payload = { 
                contents: chatHistory,
                systemInstruction: {
                    parts: CHAT_SYSTEM_INSTRUCTION.parts
                },
                generationConfig: { temperature: 0.7 } 
            };

            const aiResponseText = await callGemini(payload);
            chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

            chatWindow.removeChild(typingIndicator);
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';
            aiBubble.innerHTML = marked.parse(aiResponseText);
            chatWindow.appendChild(aiBubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        // --- Feature 3: Image Lookup ---
        function previewImage(event) {
            const files = event.target.files;
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const lookupBtn = document.getElementById('lookup-image-btn');
            imagePreviewContainer.innerHTML = '';
            base64Images = [];
            
            if (files.length === 0) {
                lookupBtn.disabled = true;
                return;
            };

            lookupBtn.disabled = true;
            let filesProcessed = 0;

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')){ 
                    filesProcessed++;
                    return; 
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-wrapper animate__animated animate__zoomIn';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    wrapper.appendChild(img);
                    imagePreviewContainer.appendChild(wrapper);

                    const base64Data = e.target.result.split(',')[1];
                    base64Images.push({ mime_type: file.type, data: base64Data });
                    
                    filesProcessed++;
                    if (filesProcessed === files.length && base64Images.length > 0) {
                        lookupBtn.disabled = false;
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function lookupByImage() {
            if (base64Images.length === 0) {
                alert("Vui lòng chọn một hoặc nhiều hình ảnh trước.");
                return;
            }
            showLoader('image-lookup-result');
            const prompt = getImageLookupPrompt();
            const parts = [{ text: prompt }];
            base64Images.forEach(img => {
                parts.push({ inline_data: { mime_type: img.mime_type, data: img.data } });
            });

            const payload = { contents: [{ parts: parts }], generationConfig: { temperature: 0.4 } }; // Tăng nhẹ temp để linh hoạt hơn
            const resultText = await callGemini(payload);
            renderMarkdown('image-lookup-result', resultText);
        }

        // [NEW] Hàm tạo hiệu ứng nền động
        function createFloatingIcons() {
            const container = document.getElementById('background-animations');
            const icons = ['❤️', '➕', '🌿', '💊'];
            const iconCount = 30; // Số lượng icon

            for (let i = 0; i < iconCount; i++) {
                const icon = document.createElement('span');
                icon.className = 'floating-icon';
                icon.textContent = icons[Math.floor(Math.random() * icons.length)];
                
                // Random vị trí, kích thước, và tốc độ
                icon.style.left = `${Math.random() * 100}vw`;
                icon.style.fontSize = `${Math.random() * 1.5 + 1}rem`; // 1rem to 2.5rem
                icon.style.animationDuration = `${Math.random() * 20 + 15}s`; // 15s to 35s
                icon.style.animationDelay = `${Math.random() * 15}s`;
                
                container.appendChild(icon);
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', function() {
            createFloatingIcons(); // Gọi hàm tạo hiệu ứng khi trang tải xong
        });
    </script>
</body>
</html>
