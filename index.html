<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·ª£ l√Ω Y t·∫ø AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            /* L∆∞·ª£c b·ªè background-image c≈© ƒë·ªÉ thay b·∫±ng hi·ªáu ·ª©ng ƒë·ªông */
        }
        
        /* [NEW] Hi·ªáu ·ª©ng n·ªÅn ƒë·ªông */
        #background-animations {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-image: radial-gradient(#dbeafe 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .floating-icon {
            position: absolute;
            bottom: -100px;
            font-size: 2rem;
            color: rgba(59, 130, 246, 0.2);
            animation: floatUp linear infinite;
            user-select: none;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            10%, 90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh);
                opacity: 0;
            }
        }
        /* K·∫øt th√∫c hi·ªáu ·ª©ng n·ªÅn */

        .view {
            display: none;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 1.5rem;
        }
        .main-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .gradient-border {
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px; 
            border-radius: inherit;
            background: linear-gradient(145deg, #3b82f6, #10b981, #8b5cf6);
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 10px;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(10px);
            animation: bubble-in 0.5s forwards;
        }
        @keyframes bubble-in {
            to { opacity: 1; transform: translateY(0); }
        }

        .user-bubble {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .ai-bubble {
            background-color: #ffffff;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-bubble.typing {
            font-style: italic;
            color: #6b7280;
        }

        .lookup-result-content h1 { font-size: 1.8rem; font-weight: 800; color: #1e3a8a; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .lookup-result-content h2 { font-size: 1.3rem; font-weight: 700; color: #1d4ed8; margin-top: 2rem; margin-bottom: 0.75rem; }
        .lookup-result-content ul { list-style-type: none; padding-left: 0; }
        .lookup-result-content li { background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2310b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>') no-repeat left center; padding-left: 28px; margin-bottom: 0.75rem; line-height: 1.6; }
        .lookup-result-content strong { color: #1f2937; font-weight: 600; }
        .lookup-result-content p { margin-bottom: 0.5rem; line-height: 1.6; }
        .lookup-result-content code { background-color: #eef2ff; color: #4338ca; padding: 2px 6px; border-radius: 6px; font-family: monospace; }
        
        #image-preview-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        #image-preview-container .img-wrapper { position: relative; }
        #image-preview-container img { height: 10rem; width: 10rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); object-fit: cover; border: 2px solid transparent; transition: all 0.2s ease; }
        #image-preview-container img:hover { transform: scale(1.05); border-color: #6366f1; }
        
        .animate-modal-scale-in {
            animation: modal-scale-in 0.5s cubic-bezier(0.165, 0.840, 0.440, 1.000) both;
        }
        @keyframes modal-scale-in {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        .pro-input {
            border: 1px solid #d1d5db;
            transition: all 0.3s;
        }
        .pro-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .pro-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .pro-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1);
        }
        .pro-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="background-animations"></div>

    <div id="welcome-modal" class="fixed top-0 left-0 right-0 bottom-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center animate-modal-scale-in">
            <lottie-player src="https://lottie.host/0c973623-a523-45aa-9782-d6b33b7aaa4e/7RZ7RZ57x7.json" background="transparent" speed="1" style="width: 150px; height: 150px; margin: 0 auto;" loop autoplay></lottie-player>
            <h2 class="text-3xl font-bold text-blue-700 mb-3">L∆∞u √Ω Quan Tr·ªçng</h2>
            <p class="text-gray-600 mb-6">
                Th√¥ng tin t·ª´ "Tr·ª£ l√Ω Y t·∫ø AI" ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o, <strong>kh√¥ng thay th·∫ø</strong> cho ch·∫©n ƒëo√°n v√† ch·ªâ ƒë·ªãnh c·ªßa b√°c sƒ©.
                <br><br>
                Vui l√≤ng ƒë·∫øn c∆° s·ªü y t·∫ø ƒë·ªÉ nh·∫≠n t∆∞ v·∫•n ch√≠nh x√°c nh·∫•t.
            </p>
            <button onclick="acceptDisclaimer()" class="pro-btn bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 w-full md:w-auto">
                T√¥i ƒë√£ hi·ªÉu v√† ƒë·ªìng √Ω
            </button>
        </div>
    </div>
    
    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6 flex flex-col flex-grow w-full">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-green-500 py-2">
                Tr·ª£ l√Ω Y t·∫ø AI
            </h1>
            <p class="text-gray-500 mt-2 text-lg">N·ªÅn t·∫£ng tra c·ª©u thu·ªëc v√† t∆∞ v·∫•n s·ª©c kh·ªèe th√¥ng minh</p>
        </header>

        <div id="main-menu" class="view">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <button onclick="showView('text-lookup-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://lottie.host/38382a88-3596-49f4-9878-e1b1149a8395/129xXoMyvW.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-blue-700">Tra c·ª©u th√¥ng tin thu·ªëc</h2>
                    <p class="text-gray-600 mt-2">Nh·∫≠p t√™n thu·ªëc ƒë·ªÉ xem chi ti·∫øt c√¥ng d·ª•ng, li·ªÅu d√πng v√† l∆∞u √Ω.</p>
                </button>
                
                <button onclick="showView('ai-chat-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://assets9.lottiefiles.com/packages/lf20_vPnn3K.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-green-700">Tr√≤ chuy·ªán v·ªõi B√°c sƒ© AI</h2>
                    <p class="text-gray-600 mt-2">H·ªèi ƒë√°p v·ªÅ tri·ªáu ch·ª©ng v√† nh·∫≠n l·ªùi khuy√™n s·ª©c kh·ªèe ban ƒë·∫ßu.</p>
                </button>

                <button onclick="showView('image-lookup-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://lottie.host/f61f9fda-34c3-4200-a031-03cbe68011cd/e8DTjYj8hL.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-indigo-700">Tra c·ª©u b·∫±ng h√¨nh ·∫£nh</h2>
                    <p class="text-gray-600 mt-2">Ch·ª•p ·∫£nh h·ªôp thu·ªëc ƒë·ªÉ AI nh·∫≠n di·ªán v√† cung c·∫•p th√¥ng tin.</p>
                </button>

                <button onclick="showView('copyright-view')" class="main-card p-8 text-left group">
                    <lottie-player src="https://lottie.host/93c183f4-f0ad-4331-b02b-7c52b1d47263/mQsl6EePvt.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin-bottom: 1rem;" loop autoplay></lottie-player>
                    <h2 class="text-2xl font-bold text-gray-700">Th√¥ng tin & B·∫£n quy·ªÅn</h2>
                    <p class="text-gray-600 mt-2">Chi ti·∫øt v·ªÅ ƒë∆°n v·ªã ph√°t tri·ªÉn ·ª©ng d·ª•ng.</p>
                </button>
            </div>
        </div>
        
        <div class="view-container bg-white/80 backdrop-blur-lg rounded-2xl shadow-lg p-6 md:p-8 border border-gray-200/50" style="display: none;">
            </div>

        <template id="text-lookup-view-template">
            <button onclick="showView('main-menu')" class="mb-6 text-blue-600 hover:underline font-semibold">&larr; Quay l·∫°i trang ch·ªß</button>
            <h2 class="text-3xl font-bold mb-6 text-blue-800">üíä Tra c·ª©u th√¥ng tin thu·ªëc</h2>
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <input id="drug-name-input" type="text" placeholder="Nh·∫≠p t√™n thu·ªëc, v√≠ d·ª•: Paracetamol, thu·ªëc ho,..." class="flex-grow p-3 border rounded-lg pro-input">
                <button id="lookup-drug-btn" onclick="lookupDrug()" class="pro-btn bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">
                    Tra c·ª©u
                </button>
            </div>
            <div id="text-lookup-result" class="bg-gray-50 p-6 rounded-lg shadow-inner flex-grow overflow-y-auto break-words lookup-result-content min-h-[300px]">
                <p class="text-gray-500">K·∫øt qu·∫£ tra c·ª©u s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
            </div>
        </template>
        
        <template id="ai-chat-view-template">
             <button onclick="showView('main-menu')" class="mb-6 text-green-600 hover:underline font-semibold">&larr; Quay l·∫°i trang ch·ªß</button>
            <h2 class="text-3xl font-bold mb-4 text-green-800">üë®‚Äç‚öïÔ∏è Tr√≤ chuy·ªán v·ªõi B√°c sƒ© AI</h2>
            <div id="chat-window" class="flex-grow bg-gray-50 p-4 rounded-lg shadow-inner overflow-y-auto h-96 flex flex-col space-y-4 mb-4">
                </div>
            <div class="flex gap-4">
                <input id="chat-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." class="flex-grow p-3 border rounded-lg pro-input focus:ring-green-500 focus:border-green-500">
                <button id="send-chat-btn" onclick="sendChatMessage()" class="pro-btn bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700">
                    G·ª≠i
                </button>
            </div>
        </template>
        
        <template id="image-lookup-view-template">
            <button onclick="showView('main-menu')" class="mb-6 text-indigo-600 hover:underline font-semibold">&larr; Quay l·∫°i trang ch·ªß</button>
            <h2 class="text-3xl font-bold mb-4 text-indigo-800">üì∏ Tra c·ª©u thu·ªëc b·∫±ng h√¨nh ·∫£nh</h2>
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-4 text-center">
                 <input type="file" id="image-upload-input" class="hidden" accept="image/*" onchange="previewImage(event)" multiple>
                 <label for="image-upload-input" class="cursor-pointer bg-indigo-100 text-indigo-700 font-semibold py-3 px-5 rounded-lg border-2 border-dashed border-indigo-300 hover:bg-indigo-200 transition-colors duration-300">
                     Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu ·∫£nh
                 </label>
                 <div id="image-preview-container"></div>
            </div>
            <button id="lookup-image-btn" onclick="lookupByImage()" class="w-full pro-btn bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none" disabled>
                Ph√¢n t√≠ch ·∫£nh
            </button>
            <div id="image-lookup-result" class="bg-gray-50 p-6 rounded-lg shadow-inner mt-4 flex-grow overflow-y-auto break-words lookup-result-content min-h-[300px]">
                 <p class="text-gray-500">K·∫øt qu·∫£ ph√¢n t√≠ch h√¨nh ·∫£nh s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
            </div>
        </template>

        <template id="copyright-view-template">
             <button onclick="showView('main-menu')" class="mb-6 text-gray-600 hover:underline font-semibold">&larr; Quay l·∫°i trang ch·ªß</button>
            <div class="text-center">
                <lottie-player src="https://lottie.host/93c183f4-f0ad-4331-b02b-7c52b1d47263/mQsl6EePvt.json" background="transparent" speed="1" style="width: 150px; height: 150px; margin: 0 auto 1rem;" loop autoplay></lottie-player>
                <h2 class="text-3xl font-bold mb-2">Th√¥ng tin B·∫£n quy·ªÅn</h2>
                <p class="text-gray-700 text-lg">·ª®ng d·ª•ng n√†y ƒë∆∞·ª£c ph√°t tri·ªÉn v√† gi·ªØ b·∫£n quy·ªÅn b·ªüi:</p>
                <p class="font-bold text-2xl mt-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">Tr∆∞∆°ng ƒê·ª©c Hi·∫øu & Nguy·ªÖn Duy H∆∞ng</p>
            </div>
        </template>
    </div>

    <footer class="text-center p-4 mt-auto">
        <p class="text-gray-500">&copy; 2025 Tr·ª£ l√Ω Y t·∫ø AI. Ph√°t tri·ªÉn b·ªüi Tr∆∞∆°ng ƒê·ª©c Hi·∫øu & Nguy·ªÖn Duy H∆∞ng.</p>
    </footer>

    <script>
        // --- Configuration ---
        const API_KEY = "AIzaSyA1dLu0OqYQX6FMwPYnza9SQPDBOM_7LIo"; // !!! QUAN TR·ªåNG: Thay th·∫ø b·∫±ng API Key c·ªßa b·∫°n
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        
        // --- State Management ---
        let chatHistory = [];
        let base64Images = [];

        // --- PROMPT ENGINEERING: Upgraded Prompts ---

        const CHAT_SYSTEM_INSTRUCTION = {
            parts: [{ text: `B·∫°n l√† m·ªôt "B√°c sƒ© AI" - m·ªôt tr·ª£ l√Ω y t·∫ø ·∫£o. H√£y tu√¢n th·ªß nghi√™m ng·∫∑t c√°c quy t·∫Øc sau trong m·ªçi t∆∞∆°ng t√°c:
1.  **Persona (Vai tr√≤):** Lu√¥n duy tr√¨ gi·ªçng vƒÉn t·∫≠n t√¢m, th·∫•u hi·ªÉu, th√¢n thi·ªán v√† chuy√™n nghi·ªáp. S·ª≠ d·ª•ng ng√¥n ng·ªØ d·ªÖ hi·ªÉu, tr√°nh bi·ªát ng·ªØ y khoa ph·ª©c t·∫°p. B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán b·∫±ng l·ªùi ch√†o ·∫•m √°p.
2.  **Disclaimer (Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám):** Trong c√¢u tr·∫£ l·ªùi ƒê·∫¶U TI√äN v√† l·∫∑p l·∫°i khi c·∫ßn thi·∫øt (v√≠ d·ª•: khi ng∆∞·ªùi d√πng h·ªèi v·ªÅ ch·∫©n ƒëo√°n ho·∫∑c ƒë∆°n thu·ªëc), h√£y nh·∫•n m·∫°nh r·∫±ng b·∫°n ch·ªâ cung c·∫•p th√¥ng tin tham kh·∫£o v√† kh√¥ng th·ªÉ thay th·∫ø cho vi·ªác ch·∫©n ƒëo√°n tr·ª±c ti·∫øp t·ª´ b√°c sƒ© chuy√™n khoa. Khuy·∫øn kh√≠ch ng∆∞·ªùi d√πng ƒë·∫øn g·∫∑p b√°c sƒ©.
3.  **NƒÉng l·ª±c:**
    * **T∆∞ v·∫•n tri·ªáu ch·ª©ng:** Ph√¢n t√≠ch c√°c tri·ªáu ch·ª©ng ng∆∞·ªùi d√πng cung c·∫•p, ƒë∆∞a ra c√°c kh·∫£ nƒÉng c√≥ th·ªÉ x·∫£y ra (kh√¥ng kh·∫≥ng ƒë·ªãnh ch·∫©n ƒëo√°n) v√† khuy√™n n√™n ƒëi kh√°m chuy√™n khoa n√†o.
    * **Th√¥ng tin thu·ªëc:** Cung c·∫•p th√¥ng tin chi ti·∫øt v·ªÅ thu·ªëc.
    * **L·ªùi khuy√™n s·ª©c kh·ªèe:** ƒê∆∞a ra l·ªùi khuy√™n v·ªÅ l·ªëi s·ªëng, dinh d∆∞·ª°ng, ph√≤ng b·ªánh.
4.  **Gi·ªõi h·∫°n:** Tuy·ªát ƒë·ªëi KH√îNG ƒë∆∞a ra ch·∫©n ƒëo√°n y khoa cu·ªëi c√πng. KH√îNG k√™ ƒë∆°n thu·ªëc. KH√îNG thay th·∫ø b√°c sƒ©. N·∫øu ƒë∆∞·ª£c y√™u c·∫ßu l√†m nh·ªØng vi·ªác n√†y, h√£y t·ª´ ch·ªëi m·ªôt c√°ch l·ªãch s·ª± v√† gi·∫£i th√≠ch l√Ω do.
5.  **ƒê·ªãnh d·∫°ng:** S·ª≠ d·ª•ng Markdown (in ƒë·∫≠m, g·∫°ch ƒë·∫ßu d√≤ng) ƒë·ªÉ tr√¨nh b√†y th√¥ng tin m·ªôt c√°ch r√µ r√†ng, d·ªÖ ƒë·ªçc.`}]
        };

        const initialAiMessage = {
            role: "model",
            parts: [{ text: "Ch√†o b·∫°n! T√¥i l√† b√°c sƒ© AI, r·∫•t vui ƒë∆∞·ª£c tr√≤ chuy·ªán v√† l·∫Øng nghe b·∫°n. B·∫°n ƒëang c√≥ bƒÉn khoƒÉn hay v·∫•n ƒë·ªÅ s·ª©c kh·ªèe n√†o c·∫ßn t√¥i t∆∞ v·∫•n kh√¥ng? H√£y c·ª© tho·∫£i m√°i chia s·∫ª nh√©! T√¥i s·∫Ω c·ªë g·∫Øng h·∫øt s·ª©c ƒë·ªÉ ƒë∆∞a ra nh·ªØng l·ªùi khuy√™n h·ªØu √≠ch v√† d·ªÖ hi·ªÉu nh·∫•t cho b·∫°n. \n\n**L∆∞u √Ω quan tr·ªçng:** Nh·ªØng th√¥ng tin t√¥i chia s·∫ª ch·ªâ mang t√≠nh tham kh·∫£o th√¥i. ƒê·ªÉ c√≥ ch·∫©n ƒëo√°n ch√≠nh x√°c v√† ƒëi·ªÅu tr·ªã chuy√™n s√¢u, b·∫°n h√£y t√¨m g·∫∑p b√°c sƒ© chuy√™n khoa ƒë·ªÉ ƒë∆∞·ª£c thƒÉm kh√°m tr·ª±c ti·∫øp nh√©!" }]
        };

        // [UPDATED] Prompt tra c·ª©u thu·ªëc linh ho·∫°t h∆°n
        function getTextLookupPrompt(drugName) {
            return `B·∫°n l√† m·ªôt tr·ª£ l√Ω d∆∞·ª£c ph·∫©m AI th√¢n thi·ªán. Ng∆∞·ªùi d√πng mu·ªën t√¨m hi·ªÉu v·ªÅ "${drugName}".
Nhi·ªám v·ª• c·ªßa b·∫°n l√†:
1.  **∆Øu ti√™n nh·∫≠n d·∫°ng:** C·ªë g·∫Øng h·∫øt s·ª©c ƒë·ªÉ x√°c ƒë·ªãnh xem "${drugName}" c√≥ ph·∫£i l√† m·ªôt lo·∫°i thu·ªëc c·ª• th·ªÉ (T√¢y y, ƒê√¥ng y, thu·ªëc nam,...) kh√¥ng.
2.  **N·∫øu nh·∫≠n d·∫°ng ƒë∆∞·ª£c:**
    * Cung c·∫•p th√¥ng tin quan tr·ªçng nh·∫•t m·ªôt c√°ch r√µ r√†ng: **C√¥ng d·ª•ng ch√≠nh, C√°ch d√πng tham kh·∫£o, v√† T√°c d·ª•ng ph·ª• c·∫ßn l∆∞u √Ω.**
    * Tr√¨nh b√†y d∆∞·ªõi d·∫°ng Markdown d·ªÖ ƒë·ªçc, kh√¥ng c·∫ßn theo m·ªôt khu√¥n m·∫´u qu√° c·ª©ng nh·∫Øc.
3.  **N·∫øu KH√îNG nh·∫≠n d·∫°ng ƒë∆∞·ª£c ho·∫∑c th√¥ng tin qu√° chung chung (v√≠ d·ª•: "thu·ªëc ho", "thu·ªëc nam", "thu·ªëc b·ªï"):**
    * **ƒê·ª´ng b√°o l·ªói.** Thay v√†o ƒë√≥, h√£y cung c·∫•p th√¥ng tin t·ªïng quan, h·ªØu √≠ch li√™n quan ƒë·∫øn ch·ªß ƒë·ªÅ ƒë√≥.
    * V√≠ d·ª• v·ªõi "thu·ªëc ho": H√£y gi·∫£i th√≠ch v·ªÅ c√°c lo·∫°i thu·ªëc ho kh√°c nhau (long ƒë·ªùm, gi·∫£m ho khan), ch√∫ng ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o, v√† khi n√†o n√™n s·ª≠ d·ª•ng lo·∫°i n√†o.
    * V√≠ d·ª• v·ªõi "thu·ªëc nam": H√£y gi·ªõi thi·ªáu s∆° l∆∞·ª£c v·ªÅ y h·ªçc c·ªï truy·ªÅn Vi·ªát Nam, n√™u m·ªôt v√†i v·ªã thu·ªëc nam ph·ªï bi·∫øn cho c√°c b·ªánh th√¥ng th∆∞·ªùng (nh∆∞ tr·ªã c·∫£m, ho) v√† nh·∫•n m·∫°nh t·∫ßm quan tr·ªçng c·ªßa vi·ªác tham kh·∫£o √Ω ki·∫øn th·∫ßy thu·ªëc y h·ªçc c·ªï truy·ªÅn.
4.  **Lu√¥n k·∫øt th√∫c b·∫±ng l·ªùi khuy√™n:** Nh·∫Øc nh·ªü ng∆∞·ªùi d√πng r·∫±ng th√¥ng tin n√†y ch·ªâ ƒë·ªÉ tham kh·∫£o v√† h·ªç **lu√¥n ph·∫£i tu√¢n theo ch·ªâ ƒë·ªãnh c·ªßa b√°c sƒ© ho·∫∑c d∆∞·ª£c sƒ©** tr∆∞·ªõc khi s·ª≠ d·ª•ng b·∫•t k·ª≥ lo·∫°i thu·ªëc n√†o.

H√£y b·∫Øt ƒë·∫ßu ph√¢n t√≠ch v√† tr·∫£ l·ªùi m·ªôt c√°ch h·ªØu √≠ch nh·∫•t.`;
        }

        // [UPDATED] Prompt tra c·ª©u ·∫£nh linh ho·∫°t h∆°n
        function getImageLookupPrompt() {
            return `B·∫°n l√† m·ªôt chuy√™n gia d∆∞·ª£c ph·∫©m AI. Ph√¢n t√≠ch c√°c h√¨nh ·∫£nh ƒë∆∞·ª£c cung c·∫•p.
1.  **C·ªë g·∫Øng nh·∫≠n d·∫°ng:** X√°c ƒë·ªãnh t√™n thu·ªëc, ho·∫°t ch·∫•t, v√† c√°c th√¥ng tin quan tr·ªçng kh√°c t·ª´ ·∫£nh.
2.  **N·∫øu nh·∫≠n d·∫°ng th√†nh c√¥ng:** Cung c·∫•p th√¥ng tin chi ti·∫øt v·ªÅ thu·ªëc ƒë√≥ (c√¥ng d·ª•ng, li·ªÅu d√πng, t√°c d·ª•ng ph·ª•).
3.  **N·∫øu ·∫£nh m·ªù ho·∫∑c kh√¥ng th·ªÉ nh·∫≠n d·∫°ng r√µ:**
    * **ƒê·ª´ng ch·ªâ b√°o l·ªói.** H√£y th·ª≠ m√¥ t·∫£ nh·ªØng g√¨ b·∫°n th·∫•y v√† ƒë∆∞a ra ph·ªèng ƒëo√°n n·∫øu c√≥ th·ªÉ. V√≠ d·ª•: "H√¨nh ·∫£nh h∆°i m·ªù, nh∆∞ng d∆∞·ªùng nh∆∞ ƒë√¢y l√† m·ªôt v·ªâ thu·ªëc kh√°ng sinh. B·∫°n c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c ch·ªØ n√†o tr√™n v·ªâ thu·ªëc kh√¥ng?"
    * G·ª£i √Ω ng∆∞·ªùi d√πng ch·ª•p l·∫°i ·∫£nh r√µ n√©t h∆°n ho·∫∑c cung c·∫•p th√™m th√¥ng tin.
4.  **N·∫øu kh√¥ng c√≥ thu·ªëc n√†o trong ·∫£nh:** Nh·∫≠n x√©t m·ªôt c√°ch l·ªãch s·ª± v·ªÅ n·ªôi dung c·ªßa ·∫£nh.
5.  **Lu√¥n bao g·ªìm disclaimer:** Nh·∫Øc nh·ªü ng∆∞·ªùi d√πng th√¥ng tin ch·ªâ mang t√≠nh tham kh·∫£o v√† c·∫ßn h·ªèi √Ω ki·∫øn chuy√™n gia y t·∫ø.`;
        }
        
        // --- UI Control ---
        function acceptDisclaimer() {
            const modal = document.getElementById('welcome-modal');
            const app = document.getElementById('app');
            modal.classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => {
                modal.style.display = 'none';
                app.style.display = 'flex';
                showView('main-menu');
            }, 500);
        }

        function showView(viewId) {
            const mainMenu = document.getElementById('main-menu');
            const viewContainer = document.querySelector('.view-container');
            
            mainMenu.style.display = 'none';
            viewContainer.style.display = 'none';

            const currentlyVisible = document.querySelector('.view.active');
            if (currentlyVisible) {
                currentlyVisible.classList.remove('active', 'animate__animated', 'animate__fadeIn');
            }

            if (viewId === 'main-menu') {
                mainMenu.style.display = 'block';
                mainMenu.classList.add('view', 'active', 'animate__animated', 'animate__fadeIn');
            } else {
                const template = document.getElementById(`${viewId}-template`);
                if (template) {
                    viewContainer.innerHTML = template.innerHTML;
                    viewContainer.style.display = 'block';
                    viewContainer.classList.add('view', 'active', 'animate__animated', 'animate__fadeIn');
                    addEventListenersForView(viewId);

                    if (viewId === 'ai-chat-view') {
                        initializeChat();
                    }
                }
            }
        }
        
        function addEventListenersForView(viewId) {
            if (viewId === 'text-lookup-view') {
                 document.getElementById('drug-name-input').addEventListener('keypress', e => e.key === 'Enter' && lookupDrug());
            } else if (viewId === 'ai-chat-view') {
                 document.getElementById('chat-input').addEventListener('keypress', e => e.key === 'Enter' && sendChatMessage());
            }
        }
        
        function showLoader(resultElementId) {
            const resultDiv = document.getElementById(resultElementId);
            resultDiv.innerHTML = `<div class="flex flex-col items-center justify-center p-8">
                <lottie-player src="https://assets3.lottiefiles.com/packages/lf20_hymw0cm6.json" background="transparent" speed="1" style="width: 150px; height: 150px;" loop autoplay></lottie-player>
                <p class="text-center text-gray-500 mt-4">AI ƒëang ph√¢n t√≠ch, vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
            </div>`;
        }

        function renderMarkdown(elementId, text) {
            const element = document.getElementById(elementId);
            element.innerHTML = marked.parse(text);
        }

        // --- API Call Logic ---
        async function callGemini(payload) {
             if (!API_KEY || API_KEY === "") {
                 return "L·ªói: Vui l√≤ng thay th·∫ø **API Key m·∫´u** trong file m√£ ngu·ªìn b·∫±ng **API Key c·ªßa ch√≠nh b·∫°n** ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y. B·∫°n c√≥ th·ªÉ l·∫•y API Key t·ª´ Google AI Studio.";
             }
             try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    throw new Error(errorData.error.message);
                }
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                     return result.candidates[0].content.parts[0].text;
                } else {
                     console.error("Invalid API Response:", result);
                     let finishReason = result.candidates?.[0]?.finishReason;
                     if (finishReason === 'SAFETY') {
                         return "Ph·∫£n h·ªìi t·ª´ AI ƒë√£ b·ªã ch·∫∑n v√¨ l√Ω do an to√†n. Vui l√≤ng ƒëi·ªÅu ch·ªânh c√¢u h·ªèi c·ªßa b·∫°n.";
                     }
                     return "L·ªói: Ph·∫£n h·ªìi t·ª´ AI kh√¥ng h·ª£p l·ªá ho·∫∑c r·ªóng. Vui l√≤ng th·ª≠ l·∫°i.";
                }
             } catch(error) {
                console.error("Fetch Error:", error);
                return `ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi ƒë·∫øn AI: ${error.message}. Vui l√≤ng ki·ªÉm tra l·∫°i API Key v√† k·∫øt n·ªëi m·∫°ng.`;
             }
        }
        
        // --- Feature 1: Text Lookup ---
        async function lookupDrug() {
            const drugName = document.getElementById('drug-name-input').value.trim();
            if (!drugName) {
                alert("Vui l√≤ng nh·∫≠p t√™n thu·ªëc.");
                return;
            }
            showLoader('text-lookup-result');
            const prompt = getTextLookupPrompt(drugName);
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.4 } }; // TƒÉng nh·∫π temp ƒë·ªÉ linh ho·∫°t h∆°n
            const resultText = await callGemini(payload);
            renderMarkdown('text-lookup-result', resultText);
        }

        // --- Feature 2: AI Chat ---
        function initializeChat() {
            chatHistory = [initialAiMessage];
            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = ''; 
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';
            aiBubble.innerHTML = marked.parse(initialAiMessage.parts[0].text);
            chatWindow.appendChild(aiBubble);
        }

        async function sendChatMessage() {
            const userInput = document.getElementById('chat-input').value.trim();
            if (!userInput) return;
            
            const chatWindow = document.getElementById('chat-window');
            
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-bubble';
            userBubble.textContent = userInput;
            chatWindow.appendChild(userBubble);
            chatHistory.push({ role: "user", parts: [{ text: userInput }] });
            document.getElementById('chat-input').value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble ai-bubble typing';
            typingIndicator.innerHTML = 'B√°c sƒ© AI ƒëang so·∫°n tin...';
            chatWindow.appendChild(typingIndicator);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const payload = { 
                contents: chatHistory,
                systemInstruction: {
                    parts: CHAT_SYSTEM_INSTRUCTION.parts
                },
                generationConfig: { temperature: 0.7 } 
            };

            const aiResponseText = await callGemini(payload);
            chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

            chatWindow.removeChild(typingIndicator);
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble ai-bubble';
            aiBubble.innerHTML = marked.parse(aiResponseText);
            chatWindow.appendChild(aiBubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        // --- Feature 3: Image Lookup ---
        function previewImage(event) {
            const files = event.target.files;
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const lookupBtn = document.getElementById('lookup-image-btn');
            imagePreviewContainer.innerHTML = '';
            base64Images = [];
            
            if (files.length === 0) {
                lookupBtn.disabled = true;
                return;
            };

            lookupBtn.disabled = true;
            let filesProcessed = 0;

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')){ 
                    filesProcessed++;
                    return; 
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-wrapper animate__animated animate__zoomIn';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    wrapper.appendChild(img);
                    imagePreviewContainer.appendChild(wrapper);

                    const base64Data = e.target.result.split(',')[1];
                    base64Images.push({ mime_type: file.type, data: base64Data });
                    
                    filesProcessed++;
                    if (filesProcessed === files.length && base64Images.length > 0) {
                        lookupBtn.disabled = false;
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function lookupByImage() {
            if (base64Images.length === 0) {
                alert("Vui l√≤ng ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu h√¨nh ·∫£nh tr∆∞·ªõc.");
                return;
            }
            showLoader('image-lookup-result');
            const prompt = getImageLookupPrompt();
            const parts = [{ text: prompt }];
            base64Images.forEach(img => {
                parts.push({ inline_data: { mime_type: img.mime_type, data: img.data } });
            });

            const payload = { contents: [{ parts: parts }], generationConfig: { temperature: 0.4 } }; // TƒÉng nh·∫π temp ƒë·ªÉ linh ho·∫°t h∆°n
            const resultText = await callGemini(payload);
            renderMarkdown('image-lookup-result', resultText);
        }

        // [NEW] H√†m t·∫°o hi·ªáu ·ª©ng n·ªÅn ƒë·ªông
        function createFloatingIcons() {
            const container = document.getElementById('background-animations');
            const icons = ['‚ù§Ô∏è', '‚ûï', 'üåø', 'üíä'];
            const iconCount = 30; // S·ªë l∆∞·ª£ng icon

            for (let i = 0; i < iconCount; i++) {
                const icon = document.createElement('span');
                icon.className = 'floating-icon';
                icon.textContent = icons[Math.floor(Math.random() * icons.length)];
                
                // Random v·ªã tr√≠, k√≠ch th∆∞·ªõc, v√† t·ªëc ƒë·ªô
                icon.style.left = `${Math.random() * 100}vw`;
                icon.style.fontSize = `${Math.random() * 1.5 + 1}rem`; // 1rem to 2.5rem
                icon.style.animationDuration = `${Math.random() * 20 + 15}s`; // 15s to 35s
                icon.style.animationDelay = `${Math.random() * 15}s`;
                
                container.appendChild(icon);
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', function() {
            createFloatingIcons(); // G·ªçi h√†m t·∫°o hi·ªáu ·ª©ng khi trang t·∫£i xong
        });
    </script>
</body>
</html>

